name: OVC Backfill then Validate (Range)

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (NY, YYYY-MM-DD)'
        required: true
        type: string
      end_date:
        description: 'End date (NY, YYYY-MM-DD, inclusive)'
        required: true
        type: string
      strict:
        description: 'Strict derived validation (true/false)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      missing_facts:
        description: 'Missing facts policy for validation (fail/skip)'
        required: false
        default: 'fail'
        type: choice
        options:
          - 'fail'
          - 'skip'

jobs:
  backfill-then-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      NEON_DSN: ${{ secrets.NEON_DSN }}
      OANDA_API_TOKEN: ${{ secrets.OANDA_API_TOKEN }}
      OANDA_ENV: ${{ secrets.OANDA_ENV }}
      BACKFILL_START_UTC: "2005-01-01T00:00:00Z"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          echo "Start date: ${{ inputs.start_date }}"
          echo "End date: ${{ inputs.end_date }}"
          echo "Strict: ${{ inputs.strict }}"
          echo "Missing facts policy: ${{ inputs.missing_facts }}"
          # Basic date format validation
          if ! [[ "${{ inputs.start_date }}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
            echo "ERROR: start_date must be YYYY-MM-DD format"
            exit 1
          fi
          if ! [[ "${{ inputs.end_date }}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
            echo "ERROR: end_date must be YYYY-MM-DD format"
            exit 1
          fi

      - name: Validate required secrets
        run: |
          python - << 'PY'
          import os, sys
          required = ["NEON_DSN", "OANDA_API_TOKEN", "OANDA_ENV"]
          missing = [k for k in required if not os.environ.get(k)]
          if missing:
              print("Missing required secrets:", missing)
              sys.exit(1)
          print("Secrets OK:", required)
          PY

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate run ID
        id: run_id
        run: |
          RUN_ID="gh_${{ github.run_id }}_${{ github.run_attempt }}"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Run ID: $RUN_ID"

      - name: Create artifacts directory
        run: |
          mkdir -p artifacts/runs/${{ steps.run_id.outputs.run_id }}

      - name: Step 1 - Backfill (OANDA â†’ Neon)
        run: |
          echo "=== BACKFILL: ${{ inputs.start_date }} to ${{ inputs.end_date }} ==="
          python src/backfill_oanda_2h_checkpointed.py \
            --start_ny "${{ inputs.start_date }}" \
            --end_ny "${{ inputs.end_date }}" \
            2>&1 | tee artifacts/runs/${{ steps.run_id.outputs.run_id }}/backfill.log

      - name: Step 2 - Validate Range (Facts vs Tape)
        run: |
          echo "=== VALIDATE: ${{ inputs.start_date }} to ${{ inputs.end_date }} ==="
          STRICT_FLAG=""
          if [ "${{ inputs.strict }}" = "true" ]; then
            STRICT_FLAG="--strict_derived"
          fi
          python src/validate_range.py \
            --symbol GBPUSD \
            --start_ny "${{ inputs.start_date }}" \
            --end_ny "${{ inputs.end_date }}" \
            --missing_facts "${{ inputs.missing_facts }}" \
            --out_dir "artifacts/runs/${{ steps.run_id.outputs.run_id }}" \
            $STRICT_FLAG \
            2>&1 | tee artifacts/runs/${{ steps.run_id.outputs.run_id }}/validate.log

      - name: Copy validation reports to artifacts
        if: always()
        run: |
          # Copy any generated reports to artifacts folder
          if [ -d "reports/validation" ]; then
            cp -r reports/validation/* artifacts/runs/${{ steps.run_id.outputs.run_id }}/ 2>/dev/null || true
          fi
          # Write run metadata
          cat > artifacts/runs/${{ steps.run_id.outputs.run_id }}/run_meta.json << EOF
          {
            "run_id": "${{ steps.run_id.outputs.run_id }}",
            "github_run_id": "${{ github.run_id }}",
            "github_run_attempt": "${{ github.run_attempt }}",
            "start_date": "${{ inputs.start_date }}",
            "end_date": "${{ inputs.end_date }}",
            "strict": "${{ inputs.strict }}",
            "missing_facts": "${{ inputs.missing_facts }}",
            "triggered_by": "${{ github.actor }}",
            "triggered_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow": "backfill_then_validate"
          }
          EOF

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ovc-run-${{ steps.run_id.outputs.run_id }}
          path: artifacts/runs/${{ steps.run_id.outputs.run_id }}/
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## OVC Backfill + Validate Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run ID | \`${{ steps.run_id.outputs.run_id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Start Date | ${{ inputs.start_date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| End Date | ${{ inputs.end_date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Strict | ${{ inputs.strict }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Missing Facts | ${{ inputs.missing_facts }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts uploaded to: \`ovc-run-${{ steps.run_id.outputs.run_id }}\`" >> $GITHUB_STEP_SUMMARY
