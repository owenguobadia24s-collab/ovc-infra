name: Path1 Evidence Runner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours (tune later)

permissions:
  contents: write   # required for git push

jobs:
  path1:
    runs-on: ubuntu-latest

    env:
      PYTHONUTF8: "1"
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.OVC_PR_BOT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Debug runner source (path + lines 1235-1260)
        run: |
          python3 - << 'PY'
          from pathlib import Path
          
          path = Path("scripts/path1/run_evidence_queue.py").resolve()
          print(f"Runner path: {path}")
          
          start, end = 1235, 1260
          lines = path.read_text(encoding="utf-8").splitlines()
          for i in range(start, end + 1):
              if 1 <= i <= len(lines):
                  print(f"{i:04d}: {lines[i-1]}")
              else:
                  print(f"{i:04d}: <EOF>")
          PY

      - name: Run Path1 evidence queue (once)
        id: runner
        continue-on-error: true
        run: |
          set -euo pipefail
          python scripts/path1/run_evidence_queue.py --once --max-runs 1

      - name: Detect changes
        id: diff
        if: always()
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            git status --porcelain
          fi

      - name: Commit ledger update
        id: commit
        if: always() && steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "ovc-ledger-bot"
          git config user.email "bot@ovc.local"
          echo "=== STATUS BEFORE STAGE ==="
          git status --porcelain
          git add reports/path1/evidence/INDEX.md
          if [ -d sql/path1/evidence/runs ]; then git add sql/path1/evidence/runs/; fi
          if [ -d reports/path1/evidence/runs ]; then git add reports/path1/evidence/runs/; fi
          if [ -f artifacts/path1_summary.json ]; then
            git add artifacts/path1_summary.json
          fi
          echo "=== CACHED DIFF (name-only) ==="
          git diff --cached --name-only || true
          if git diff --cached --quiet; then
            echo "No changes to commit (NOOP)"
            echo "committed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          git commit -m "path1: ledger update"
          echo "committed=true" >> $GITHUB_OUTPUT

      - name: Push ledger
        if: always() && steps.commit.outputs.committed == 'true'
        run: |
          git push

      - name: Runner status (non-blocking)
        if: always()
        run: |
          if [ "${{ steps.runner.outcome }}" != "success" ]; then
            echo "WARNING: runner step failed but ledger steps were allowed to continue."
            # exit 1
          fi
         
