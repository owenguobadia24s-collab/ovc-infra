name: Path1 Evidence Runner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours (tune later)

permissions:
  contents: write   # required for git push

jobs:
  path1:
    runs-on: ubuntu-latest

    env:
      PYTHONUTF8: "1"
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.OVC_PR_BOT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Path1 evidence queue (once)
        run: |
          set -euo pipefail
          python scripts/path1/run_evidence_queue.py --once --max-runs 1

      - name: Detect changes
        id: diff
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit ledger update
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "ovc-ledger-bot"
          git config user.email "bot@ovc.local"
          git add reports/path1/evidence sql/path1/evidence
          git commit -m "Path1: automated evidence run"

      - name: Push ledger
        if: steps.diff.outputs.changed == 'true'
        run: |
          git push

         
