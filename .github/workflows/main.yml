name: Path1 Evidence Runner

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # every 6 hours (tune later)

permissions:
  contents: write   # required for git push

jobs:
  path1:
    runs-on: ubuntu-latest

    env:
      PYTHONUTF8: "1"
      DATABASE_URL: ${{ secrets.DATABASE_URL }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.OVC_PR_BOT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Debug runner source (path + lines 1235-1260)
        run: |
          python3 - << 'PY'
          from pathlib import Path
          
          path = Path("scripts/path1/run_evidence_queue.py").resolve()
          print(f"Runner path: {path}")
          
          start, end = 1235, 1260
          lines = path.read_text(encoding="utf-8").splitlines()
          for i in range(start, end + 1):
              if 1 <= i <= len(lines):
                  print(f"{i:04d}: {lines[i-1]}")
              else:
                  print(f"{i:04d}: <EOF>")
          PY

      - name: Run Path1 evidence queue (once)
        id: runner
        run: |
          set -euo pipefail
          python scripts/path1/run_evidence_queue.py --once --max-runs 1

      - name: Stage expected Path1 ledger outputs
        id: stage
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "ovc-ledger-bot"
          git config user.email "bot@ovc.local"

          echo "=== STATUS BEFORE STAGE ==="
          git status --porcelain || true

          # Core Path1 evidence outputs
          git add reports/path1/evidence/INDEX.md || true
          git add reports/path1/evidence/runs/ || true
          git add sql/path1/evidence/runs/ || true
          git add artifacts/path1_summary.json || true

          # Governance / ledgers that commonly change during evidence runs
          git add ANCHOR_INDEX_v0_1.csv || true
          git add README_ORG_NOTES.md || true
          git add CLAIM_BINDING_v0_1.md || true

          echo "=== CACHED DIFF (name-only) ==="
          git diff --cached --name-only || true

          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "NOOP: no staged changes (queue empty, or run produced no repo mutations)."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit ledger update
        if: always() && steps.stage.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git commit -m "path1: ledger update (${GITHUB_RUN_ID})"

      - name: Push ledger
        if: always() && steps.stage.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git push
