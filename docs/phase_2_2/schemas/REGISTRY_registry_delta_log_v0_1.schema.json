{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Registry Delta Log v0.1 — Line Schema",
  "description": "Schema for individual lines in REGISTRY_DELTA_LOG_v0_1.jsonl. Each line represents a delta edge between two sealed states of a registry.",
  "schema_version": "0.1",
  "registry_id": "registry_delta_log",
  "type": "object",
  "required": [
    "delta_version",
    "registry_id",
    "from_ref",
    "to_ref",
    "delta_basis",
    "added_paths",
    "removed_paths",
    "modified_paths",
    "counts",
    "created_utc",
    "derivation_run_id"
  ],
  "properties": {
    "delta_version": {
      "type": "string",
      "const": "0.1",
      "description": "Schema version of this delta record."
    },
    "registry_id": {
      "type": "string",
      "description": "The registry being tracked (e.g., run_registry, op_status_table)."
    },
    "from_ref": {
      "oneOf": [
        { "type": "null" },
        { "$ref": "#/$defs/sealed_ref" }
      ],
      "description": "Reference to the previous sealed snapshot, or null if this is the first observation (bootstrap)."
    },
    "to_ref": {
      "$ref": "#/$defs/sealed_ref",
      "description": "Reference to the current sealed snapshot. Always non-null."
    },
    "delta_basis": {
      "type": "string",
      "enum": ["manifest_diff", "unknown"],
      "description": "How the delta was computed. 'manifest_diff' means comparing manifest.json file lists."
    },
    "added_paths": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Paths present in to_ref but not in from_ref. Sorted lexicographically."
    },
    "removed_paths": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Paths present in from_ref but not in to_ref. Sorted lexicographically."
    },
    "modified_paths": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Paths present in both but with different sha256. Sorted lexicographically."
    },
    "counts": {
      "type": "object",
      "required": ["added", "removed", "modified"],
      "properties": {
        "added": { "type": "integer", "minimum": 0 },
        "removed": { "type": "integer", "minimum": 0 },
        "modified": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": false,
      "description": "Count of added, removed, and modified paths."
    },
    "created_utc": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$",
      "description": "ISO8601 UTC timestamp of when this delta record was created.",
      "time_semantics": "point-in-time, UTC, ISO8601"
    },
    "derivation_run_id": {
      "type": "string",
      "description": "The run_id of the delta-log build that produced this record."
    }
  },
  "additionalProperties": false,
  "$defs": {
    "sealed_ref": {
      "type": "object",
      "required": ["run_id", "run_root", "relpath", "manifest_sha256"],
      "properties": {
        "run_id": {
          "type": "string",
          "description": "Run folder name (e.g., 2026-02-05__000138__run_registry_build)."
        },
        "run_root": {
          "type": "string",
          "description": "Root directory containing the run (e.g., .codex/RUNS)."
        },
        "relpath": {
          "type": ["string", "null"],
          "description": "Relative path to the primary artifact within the run folder, or null if multi-file."
        },
        "manifest_sha256": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "ROOT_SHA256 from MANIFEST.sha256 — the seal hash."
        }
      },
      "additionalProperties": false
    }
  }
}
